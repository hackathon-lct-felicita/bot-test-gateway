
# Bot Test Gateway

Высоконагруженный FastAPI сервис для распознавания именованных сущностей (NER) в тексте с использованием RabbitMQ RPC для взаимодействия с моделями машинного обучения.

## Особенности

- **Высокая производительность**: Архитектура с разделением слоев (API, Services, Models, Middleware)
- **Мониторинг**: Автоматические заголовки `X-Process-Time` и `X-Hostname`
- **Асинхронность**: Обработка через RabbitMQ RPC для взаимодействия с ML моделями
- **Оптимизация**: Конфигурация uvicorn с uvloop и httptools
- **Контейнеризация**: Поддержка Docker и docker-compose
- **Масштабируемость**: Автоматическое определение количества воркеров на основе CPU
- **Метрики**: Встроенный Prometheus exporter для мониторинга
- **Надежность**: Healthcheck endpoint для проверки состояния сервиса
- **Документация**: Автоматическая генерация OpenAPI/Swagger документации

## Установка

```bash
uv sync
```

## Запуск

### Локальный запуск

```bash
python run.py
```

### Запуск с Docker

```bash
docker-compose up --build
```

Эта команда запустит:
- Bot Test Gateway (порт 8000) с healthcheck

**Примечание**: Для работы сервиса требуется отдельно запущенный RabbitMQ сервер.

### Запуск только Dockerfile

```bash
docker build -t bot-test-gateway .
docker run -p 8000:8000 bot-test-gateway
```

## Конфигурация

Сервис использует Pydantic Settings для управления конфигурацией. Создайте файл `.env` в корне проекта:

```bash
touch .env
```

### Переменные окружения

| Переменная | Описание | По умолчанию | Обязательная |
|------------|----------|--------------|--------------|
| `RABBITMQ_URL` | URL подключения к RabbitMQ | `amqp://guest:guest@localhost:5672/` | Да |
| `HOST` | Хост для привязки сервера | `0.0.0.0` | Нет |
| `PORT` | Порт для привязки сервера | `8000` | Нет |
| `WORKERS` | Количество воркеров | `max(1, cpu_count() // 2)` | Нет |
| `LOG_LEVEL` | Уровень логирования | `INFO` | Нет |

**Примечание**: Все переменные окружения можно задать через файл `.env` или системные переменные окружения.

### Пример .env файла

```env
RABBITMQ_URL=amqp://guest:guest@localhost:5672/
HOST=0.0.0.0
PORT=8000
WORKERS=4
LOG_LEVEL=INFO
```

## Docker

Проект поддерживает развертывание через Docker с использованием многоэтапной сборки для оптимизации размера образа.

### Особенности Docker-образа

- Использует Python 3.13-slim-bookworm
- Многоэтапная сборка с uv для управления зависимостями
- Запуск от непривилегированного пользователя (nonroot)
- Автоматическая установка зависимостей из uv.lock

### Переменные окружения для Docker

При запуске через docker-compose можно использовать переменные окружения:

```bash
export PORT=8000
docker-compose up --build
```

### Требования

- Docker
- docker-compose (для docker-compose.yaml)
- Переменная окружения `PORT` (для docker-compose)
- RabbitMQ сервер (должен быть запущен отдельно)

## API

### POST /api/predict

Предсказание сущностей в тексте с использованием BIO-разметки.

**Запрос:**
```json
{
  "input": "молоко деревенское 2.5%"
}
```

**Параметры запроса:**
- `input` (string, обязательный) - входной текст для анализа

**Ответ:**
```json
[
  {
    "start_index": 0,
    "end_index": 6,
    "entity": "O"
  },
  {
    "start_index": 7,
    "end_index": 18,
    "entity": "O"
  },
  {
    "start_index": 19,
    "end_index": 23,
    "entity": "B-PERCENT"
  }
]
```

**Параметры ответа:**
- `start_index` (integer) - начальный индекс символа
- `end_index` (integer) - конечный индекс символа
- `entity` (string) - метка сущности в формате BIO

**Заголовки ответа:**
- `X-Process-Time` - время обработки запроса в секундах
- `X-Hostname` - имя хоста, обработавшего запрос

**Коды ошибок:**
- `500` - Внутренняя ошибка сервера

### GET /health

Проверка состояния сервиса.

**Ответ:**
```json
{
  "status": "healthy"
}
```

### GET /api/metrics

Prometheus метрики в формате OpenMetrics.

**Ответ:** Метрики в текстовом формате Prometheus

## Мониторинг

Сервис предоставляет встроенный Prometheus exporter для мониторинга производительности.

### Доступные метрики

- `http_requests_total` - Общее количество HTTP запросов (по методам, endpoint'ам, статус-кодам)
- `http_request_duration_seconds` - Время выполнения HTTP запросов
- `predict_requests_total` - Количество запросов на предсказание (по статусу)
- `predict_duration_seconds` - Время выполнения предсказаний
- `rpc_requests_total` - Количество RPC запросов (по статусу)
- `rpc_duration_seconds` - Время выполнения RPC запросов
- `active_connections` - Количество активных соединений
- `application_info` - Информация о приложении

### Healthcheck

Сервис поддерживает healthcheck для Docker:
- **Endpoint**: `/health`
- **Интервал проверки**: 30 секунд
- **Таймаут**: 10 секунд
- **Количество попыток**: 3
- **Период запуска**: 40 секунд

### Доступ к мониторингу

После запуска `docker-compose up --build`:

- **Приложение**: http://localhost:8000
- **Healthcheck**: http://localhost:8000/health
- **Метрики**: http://localhost:8000/api/metrics
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

**Примечание**: Для доступа к RabbitMQ Management UI необходимо запустить RabbitMQ сервер отдельно.

## Архитектура

Проект построен с использованием чистой архитектуры и принципов разделения ответственности:

```
app/
├── api/                    # API роуты и эндпоинты
│   ├── __init__.py
│   └── routes.py          # Основные маршруты API
├── config.py              # Конфигурация приложения (Pydantic Settings)
├── logging_setup.py       # Настройка логирования
├── main.py                # Точка входа FastAPI приложения
├── middleware/            # Middleware для обработки запросов
│   ├── __init__.py
│   ├── headers.py         # Middleware для добавления заголовков
│   └── metrics.py         # Middleware для сбора метрик
├── models/                # Pydantic модели и схемы
│   ├── __init__.py
│   └── schemas.py         # Схемы запросов и ответов
└── services/              # Бизнес-логика и внешние сервисы
    ├── __init__.py
    ├── metrics_service.py # Сервис для работы с метриками
    ├── predict_service.py # Сервис для предсказаний
    └── rpc_client.py      # RPC клиент для RabbitMQ
```

### Компоненты системы

- **API Layer** (`app/api/`): Обработка HTTP запросов и валидация данных
- **Services Layer** (`app/services/`): Бизнес-логика и интеграция с внешними сервисами
- **Models Layer** (`app/models/`): Pydantic модели для валидации и сериализации
- **Middleware Layer** (`app/middleware/`): Перехватчики для добавления функциональности
- **Configuration** (`app/config.py`): Централизованное управление настройками

## Разработка

### Требования

- **Python**: 3.13+
- **Менеджер пакетов**: uv
- **Message Broker**: RabbitMQ (для RPC взаимодействия)
- **Контейнеризация**: Docker и docker-compose (опционально)

### Быстрый старт для разработки

1. **Клонирование и установка зависимостей:**
   ```bash
   git clone <repository-url>
   cd bot-test-gateway
   uv sync --dev
   ```

2. **Запуск RabbitMQ (локально):**
   ```bash
   # Через Docker
   docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management
   
   # Или через Homebrew (macOS)
   brew install rabbitmq
   brew services start rabbitmq
   ```

3. **Запуск приложения:**
   ```bash
   python run.py
   ```

### Линтинг и форматирование

Проект использует **ruff** для линтинга и форматирования:

```bash
# Проверка кода
uv run ruff check .

# Форматирование кода
uv run ruff format .

# Автоматическое исправление
uv run ruff check --fix .
```

### Pre-commit хуки

Установите pre-commit хуки для автоматической проверки кода:

```bash
uv run pre-commit install
```

### Тестирование

```bash
# Запуск тестов (если есть)
uv run pytest

# Запуск с покрытием
uv run pytest --cov=app
```

### Отладка

Для отладки можно запустить приложение в режиме разработки:

```bash
# С автоперезагрузкой
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# С подробным логированием
LOG_LEVEL=DEBUG python run.py
```

## Производительность

### Оптимизации

- **uvloop**: Высокопроизводительный event loop для asyncio
- **httptools**: Быстрый HTTP парсер на C
- **Многопроцессность**: Автоматическое определение количества воркеров
- **Асинхронность**: Неблокирующие операции с RabbitMQ
- **Connection pooling**: Переиспользование соединений

### Мониторинг производительности

Сервис предоставляет детальные метрики для мониторинга:

- Время обработки запросов
- Количество активных соединений
- Статистика RPC вызовов
- Метрики ошибок

### Масштабирование

- **Горизонтальное**: Запуск нескольких экземпляров за load balancer
- **Вертикальное**: Увеличение количества воркеров
- **Кэширование**: Возможность добавления Redis для кэширования результатов

## Безопасность

### Рекомендации

- Используйте HTTPS в продакшене
- Настройте аутентификацию для RabbitMQ
- Ограничьте доступ к метрикам и healthcheck endpoints
- Регулярно обновляйте зависимости

### Переменные окружения

Никогда не коммитьте файлы `.env` с реальными паролями и токенами.

## Лицензия

Этот проект распространяется под лицензией [GNU General Public License v3.0](https://www.gnu.org/licenses/gpl-3.0.html).

## Поддержка

Для вопросов и предложений создавайте issues в репозитории проекта.